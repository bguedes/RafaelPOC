g.V().hasLabel('person').has('id', eq(personId)).bothE('knows').dedup().by(__.path()).otherV().as('friend').inE('hasCreator').outV().as('message').has('creationDate', lte(maxDate)).select('friend', 'message').project('personId', 'personFirstName', 'personLastName', 'messageId', 'messageContent', 'messageCreationDate').by(__.select('friend').choose(__.values('id'), __.values('id'), __.constant('  cypher.null'))).by(__.select('friend').choose(neq('  cypher.null'), __.choose(__.values('firstName'), __.values('firstName'), __.constant('  cypher.null')))).by(__.select('friend').choose(neq('  cypher.null'), __.choose(__.values('lastName'), __.values('lastName'), __.constant('  cypher.null')))).by(__.select('message').choose(neq('  cypher.null'), __.choose(__.values('id'), __.values('id'), __.constant('  cypher.null')))).by(__.coalesce(__.select('message').choose(neq('  cypher.null'), __.choose(__.values('content'), __.values('content'), __.constant('  cypher.null'))).is(neq('  cypher.null')), __.select('message').choose(neq('  cypher.null'), __.choose(__.values('imageFile'), __.values('imageFile'), __.constant('  cypher.null'))))).by(__.select('message').choose(neq('  cypher.null'), __.choose(__.values('creationDate'), __.values('creationDate'), __.constant('  cypher.null')))).order().by(__.select('messageCreationDate'), desc).by(__.select('messageId'), asc).limit(20)
